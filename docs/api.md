# API Documentation\n\n## Reddit API Proxy\n\nThe application uses a server-side proxy to interact with Reddit's API, providing security, caching, and rate limiting.\n\n### Endpoints\n\n#### GET `/api/reddit`\n\nFetches Reddit posts from specified subreddits.\n\n**Query Parameters:**\n\n| Parameter | Type | Required | Description |\n|-----------|------|----------|-------------|\n| `subreddit` | string | Yes | Subreddit name (e.g., \"pics\") |\n| `sortType` | string | Yes | Sort method: \"hot\" or \"top\" |\n| `timeFrame` | string | No* | Time period for \"top\" sorting: \"day\", \"week\", \"month\", \"year\", \"all\" |\n| `after` | string | No | Pagination token for loading more posts |\n| `limit` | string | No | Number of posts to return (1-100, default: 20) |\n\n*Required when `sortType` is \"top\"\n\n**Example Request:**\n```http\nGET /api/reddit?subreddit=earthporn&sortType=top&timeFrame=week&limit=25\n```\n\n**Response Format:**\n```typescript\ninterface Response {\n  posts: RedditPost[];\n  after: string | null; // Pagination token\n}\n\ninterface RedditPost {\n  title: string;\n  mediaUrls: string[];\n  subreddit: string;\n  postId: string;\n  isUnplayableVideoFormat?: boolean;\n}\n```\n\n**Success Response (200):**\n```json\n{\n  \"posts\": [\n    {\n      \"title\": \"Beautiful sunset in the mountains\",\n      \"mediaUrls\": [\"https://i.redd.it/example.jpg\"],\n      \"subreddit\": \"earthporn\",\n      \"postId\": \"abc123\",\n      \"isUnplayableVideoFormat\": false\n    }\n  ],\n  \"after\": \"t3_xyz789\"\n}\n```\n\n**Error Responses:**\n\n| Status | Description | Response |\n|--------|-------------|----------|\n| 400 | Invalid parameters | `{\"error\": \"Validation failed\", \"details\": [...]}` |\n| 429 | Rate limit exceeded | `{\"error\": \"Rate limit exceeded\", \"resetTime\": 1234567890}` |\n| 500 | Server error | `{\"error\": \"Internal server error\"}` |\n| 502 | Reddit API error | `{\"error\": \"Reddit API Error: 503\"}` |\n| 504 | Request timeout | `{\"error\": \"Request timeout\"}` |\n\n**Rate Limiting:**\n- 60 requests per hour per IP address\n- Headers included in response:\n  - `X-RateLimit-Remaining`: Requests remaining in window\n  - `X-RateLimit-Reset`: Unix timestamp when limit resets\n  - `Retry-After`: Seconds to wait (only when rate limited)\n\n### Authentication\n\nThe API handles Reddit OAuth 2.0 authentication server-side using client credentials flow. No user authentication is required.\n\n### Caching\n\n- Server-side caching with Vercel KV (Redis)\n- Cache TTL: 10 minutes for Reddit data\n- Cache keys include subreddit, sort type, time frame, and pagination\n- Automatic cache cleanup for expired entries\n\n### Security Features\n\n1. **Input Validation**: All parameters validated with Zod schemas\n2. **Rate Limiting**: Token bucket algorithm with per-IP tracking\n3. **Domain Validation**: Only approved image domains allowed\n4. **Request Timeouts**: 10-second timeout for Reddit API calls\n5. **Error Sanitization**: Internal errors not exposed to clients\n\n### Error Handling\n\n```typescript\n// Custom error class for API-specific errors\nclass RedditApiError extends Error {\n  constructor(\n    message: string,\n    public status?: number,\n    public resetTime?: number,\n    public remaining?: number\n  ) {\n    super(message);\n    this.name = 'RedditApiError';\n  }\n}\n```\n\n### Usage Examples\n\n**Fetch hot posts from multiple subreddits:**\n```typescript\nconst response = await fetch('/api/reddit?subreddit=pics&sortType=hot&limit=50');\nconst data = await response.json();\n```\n\n**Handle rate limiting:**\n```typescript\ntry {\n  const response = await fetch('/api/reddit?subreddit=funny&sortType=hot');\n  if (response.status === 429) {\n    const error = await response.json();\n    const waitTime = error.resetTime - Date.now();\n    console.log(`Rate limited. Wait ${waitTime}ms`);\n  }\n} catch (error) {\n  console.error('API request failed:', error);\n}\n```\n\n**Pagination:**\n```typescript\nlet after = null;\nconst allPosts = [];\n\nwhile (allPosts.length < 100) {\n  const url = new URL('/api/reddit', window.location.origin);\n  url.searchParams.set('subreddit', 'aww');\n  url.searchParams.set('sortType', 'hot');\n  if (after) url.searchParams.set('after', after);\n  \n  const response = await fetch(url.toString());\n  const data = await response.json();\n  \n  allPosts.push(...data.posts);\n  after = data.after;\n  \n  if (!after) break; // No more posts\n}\n```\n\n## Client-Side Services\n\n### Reddit Service (`src/services/reddit.ts`)\n\nMain service for interacting with the Reddit API proxy.\n\n**Functions:**\n\n#### `getPosts(subreddit, sortType, options)`\n\nRetrieves Reddit posts with error handling and logging.\n\n**Parameters:**\n- `subreddit`: string - Subreddit name\n- `sortType`: 'hot' | 'top' - Sort method\n- `options`: Object with optional timeFrame, after, limit\n\n**Returns:**\n- Promise resolving to `{posts, after}`\n\n**Throws:**\n- `RedditApiError` for API-specific errors\n\n#### `parseSubreddits(input)`\n\nParses comma-separated subreddit names with validation.\n\n#### `isValidSubreddit(name)`\n\nValidates individual subreddit names.\n\n#### `createCacheKey(...args)`\n\nGenerates consistent cache keys for requests.\n\n### Cache Service (`src/lib/cache.ts`)\n\nEnhanced caching with LRU eviction and TTL support.\n\n**Usage:**\n```typescript\nimport { redditCache, imageCache } from '@/lib/cache';\n\n// Store data\nredditCache.set('key', data, 600000); // 10 minutes TTL\n\n// Retrieve data\nconst cachedData = redditCache.get('key');\n\n// Check existence\nif (redditCache.has('key')) {\n  // Use cached data\n}\n\n// Get cache statistics\nconst stats = redditCache.getStats();\nconsole.log(`Cache size: ${stats.size}/${stats.maxSize}`);\n```\n\n## Environment Variables\n\n### Required\n- `REDDIT_CLIENT_ID`: Reddit app client ID\n- `REDDIT_CLIENT_SECRET`: Reddit app client secret\n\n### Optional\n- `REDDIT_USERNAME`: Reddit username (for User-Agent)\n- `KV_URL`: Vercel KV connection URL\n- `KV_REST_API_URL`: Vercel KV REST API URL\n- `KV_REST_API_TOKEN`: Vercel KV API token\n- `NODE_ENV`: Environment (development/production)\n\n### Validation\n\nEnvironment variables are validated at startup using Zod schemas:\n\n```typescript\n// Validate environment on server startup\ntry {\n  const env = getValidatedEnv();\n  console.log('Environment validation successful');\n} catch (error) {\n  console.error('Environment validation failed:', error.message);\n  process.exit(1);\n}\n```\n\n## Monitoring and Logging\n\n### Log Levels\n- `debug`: Development information\n- `info`: General application events\n- `warn`: Warning conditions\n- `error`: Error conditions requiring attention\n\n### Log Contexts\n- `auth`: Authentication and token management\n- `api`: API requests and responses\n- `client`: Client-side operations\n- `general`: General application events\n\n### Example Logs\n\n```typescript\n// API request logging\napiLogger.info('Reddit API request started', {\n  subreddit: 'pics',\n  sortType: 'hot',\n  clientId: '192.168.1.1'\n});\n\n// Error logging\napiLogger.error('Reddit API request failed', {\n  error: 'Network timeout',\n  duration: 10000,\n  subreddit: 'pics'\n});\n\n// Performance logging\nclientLogger.debug('Cache hit', {\n  cacheKey: 'reddit:pics:hot',\n  accessCount: 5,\n  age: 120000\n});\n```"